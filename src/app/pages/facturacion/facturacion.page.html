<!-- facturacion.page.html -->
<ion-content [fullscreen]="true">
  <div class="contenedor">
    <div class="contenido">

      <mat-form-field appearance="outline" class="w-100">
        <mat-label>{{ 'cliente_a_facturar' | translate }}</mat-label>
        <mat-select [(ngModel)]="userSeleccionado"
          (selectionChange)="onUserChange()">
          <mat-option *ngFor="let u of usersOptions" [value]="u.value">
            {{ u.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <div *ngIf="showFacturacionForm"
        class="d-flex gap-16 align-items-center mb-4">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'desde' | translate }}</mat-label>
          <input matInput
            [matDatepicker]="pickerDesde"
            [(ngModel)]="fechaDesde"
            name="desde">
          <mat-datepicker-toggle matSuffix
            [for]="pickerDesde"></mat-datepicker-toggle>
          <mat-datepicker #pickerDesde></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'hasta' | translate }}</mat-label>
          <input matInput
            [matDatepicker]="pickerHasta"
            [(ngModel)]="fechaHasta"
            name="hasta">
          <mat-datepicker-toggle matSuffix
            [for]="pickerHasta"></mat-datepicker-toggle>
          <mat-datepicker #pickerHasta></mat-datepicker>
        </mat-form-field>

        <button mat-flat-button
          color="primary"
          (click)="exportFacturacion()"
          [disabled]="hasChanges">
          {{ 'descargar_facturacion' | translate }}
        </button>
      </div>

      <mat-card *ngIf="showFacturacionForm" class="cardWithShadow">

        <mat-tab-group mat-stretch-tabs="false" animationDuration="0ms">

          <!-- TAB 1: PICKING -->
          <mat-tab label="{{ 'picking' | translate }}">
            <div class="tabla-wrapper p-y-12 p-x-24">
              <div
                style="display: flex; justify-content: space-between; align-items: center;">
                <mat-form-field appearance="outline" class="w-70 mb-16">
                  <mat-label>{{ 'buscar_variantes' | translate }}</mat-label>
                  <input matInput
                    [placeholder]="'escribe_para_filtrar' | translate"
                    (keyup)="applyVariantsFilter($event)">
                </mat-form-field>
                <div class="text-right p-y-12 p-x-24">

                  <button mat-flat-button
                    class="bg-error text-white"
                    (click)="onCancel()"
                    [disabled]="!hasChanges">
                    {{ 'cancelar' | translate }}
                  </button>
                  <button mat-flat-button
                    color="primary"
                    style="margin-left: 1em;"
                    (click)="saveChanges()"
                    [disabled]="!hasChanges">
                    {{ 'guardar' | translate }}
                  </button>
                </div>
              </div>

              <table mat-table [dataSource]="variantesDataSource" class="w-100">

                <!-- Imagen del producto -->
                <ng-container matColumnDef="image">
                  <th mat-header-cell *matHeaderCellDef style="width:60px;"></th>
                  <td mat-cell *matCellDef="let v">
                    <img [src]="getProductImage(v.id_producto)"
                      width="40" height="40"
                      style="border-radius:4px;" />
                  </td>
                </ng-container>

                <!-- Nombre del producto -->
                <ng-container matColumnDef="producto">
                  <th mat-header-cell *matHeaderCellDef>{{ 'producto' | translate }}</th>
                  <td mat-cell *matCellDef="let v">
                    {{ getProductName(v.id_producto) }}
                  </td>
                </ng-container>

                <!-- Nombre variante -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>{{ 'variante' | translate }}</th>
                  <td mat-cell *matCellDef="let v">{{ v.name }}</td>
                </ng-container>

                <!-- Precio Picking editable -->
                <ng-container matColumnDef="picking_price">
                  <th mat-header-cell *matHeaderCellDef>{{ 'precio_picking' | translate }}</th>
                  <td mat-cell *matCellDef="let v">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>{{ 'precio_picking' | translate }}</mat-label>
                      <input matInput
                        type="number"
                        step="0.01"
                        [ngModel]="v.picking_price"
                        (ngModelChange)="onPickingPriceChange(v.id, $event)" />
                    </mat-form-field>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="varianteColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: varianteColumns;"></tr>
              </table>

              <mat-paginator #variantePaginator
                [pageSizeOptions]="[5,10,20]"
                [pageSize]="10"
                showFirstLastButtons>
              </mat-paginator>
            </div>
          </mat-tab>

          <!-- TAB 2: ENVÍOS -->
          <mat-tab label="{{ 'envios' | translate }}">
            <div class="tabla-wrapper p-y-12 p-x-24">
              <div
                style="display: flex; justify-content: space-between; align-items: center;">
                <mat-form-field appearance="outline" class="w-70 mb-16">
                  <mat-label>{{ 'buscar_envios' | translate }}</mat-label>
                  <input matInput
                    [placeholder]="'escribe_para_filtrar' | translate"
                    (keyup)="applyShippingFilter($event)">
                </mat-form-field>
                <div class="text-right p-y-12 p-x-24">

                  <button mat-flat-button
                    class="bg-error text-white"
                    (click)="onCancel()"
                    [disabled]="!hasChanges">
                    {{ 'cancelar' | translate }}
                  </button>
                  <button mat-flat-button
                    color="primary"
                    style="margin-left: 1em;"
                    (click)="saveChanges()"
                    [disabled]="!hasChanges">
                    {{ 'guardar' | translate }}
                  </button>
                </div>
              </div>
              <table mat-table [dataSource]="shippingDataSource" matSort class="w-100">

                <!-- Nombre método -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'nombre' | translate }}</th>
                  <td mat-cell *matCellDef="let s">{{ s.label }}</td>
                </ng-container>

                <!-- Precio editable -->
                <ng-container matColumnDef="price">
                  <th mat-header-cell *matHeaderCellDef>{{ 'precio_envio' | translate }}</th>
                  <td mat-cell *matCellDef="let s">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>{{ 'precio_envio' | translate }}</mat-label>
                      <input matInput
                        type="number"
                        step="0.01"
                        [ngModel]="s.base_price"
                        (ngModelChange)="onShippingPriceChange(s.value, $event)" />
                    </mat-form-field>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="shippingColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: shippingColumns;"></tr>
              </table>

              <mat-paginator #shippingPaginator
                [pageSizeOptions]="[5,10,20]"
                [pageSize]="10"
                showFirstLastButtons>
              </mat-paginator>
            </div>
          </mat-tab>

          <!-- TAB 3: GENERAL -->
          <mat-tab label="{{ 'general' | translate }}">
            <div class="p-y-12 p-x-24">
              <div class="row mb-3">
                <div class="col-lg-12"
                  style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                  <div>
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>{{ 'precio_albaran' | translate }}</mat-label>
                      <input matInput
                        type="number"
                        step="0.01"
                        [ngModel]="invoiceCost"
                        (ngModelChange)="onInvoiceCostChange($event)" />
                    </mat-form-field>
                  </div>
                  <div class="text-right p-y-12 p-x-24">

                    <button mat-flat-button
                      class="bg-error text-white"
                      (click)="onCancel()"
                      [disabled]="!hasChanges">
                      {{ 'cancelar' | translate }}
                    </button>
                    <button mat-flat-button
                      color="primary"
                      style="margin-left: 1em;"
                      (click)="saveChanges()"
                      [disabled]="!hasChanges">
                      {{ 'guardar' | translate }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </mat-tab>

        </mat-tab-group>

      </mat-card>

    </div>
  </div>
</ion-content>
