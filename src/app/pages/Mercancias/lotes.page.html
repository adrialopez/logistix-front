<ion-content [fullscreen]="true">
  <div class="contenedor">
    <div class="contenido" [ngClass]="{'sin-padding': compact}">

      <!-- SOLO muestra top cards y filtros si NO está en modo compacto con solo buscador -->
      <ng-container *ngIf="!(compact && showOnlySearch)">
        <div class="row" *ngIf="!compact"
          style="display:flex; justify-content: center;">

          <div class="topcard-item col-sm-6 col-lg-4">
            <mat-card class="text-center">
              <mat-card-content>
                <img
                  src="/assets/images/lotesSinCaducidadProxima.png"
                  alt="users"
                  width="70" />
                <h4 class="f-s-14 f-w-600 text-primary m-t-8">
                  Lotes correctos
                </h4>
                <h6 class="f-s-21 f-w-600 text-primary m-t-8">
                  {{caducidades.ok.toString()}}
                </h6>
              </mat-card-content>
            </mat-card>
          </div>
          <div class="topcard-item col-sm-6 col-lg-4">
            <mat-card class="text-center">
              <mat-card-content>
                <img
                  src="/assets/images/lotesProximaCaducidad.png"
                  alt="users"
                  width="70" />
                <h4 class="f-s-14 f-w-600 text-warning m-t-8">
                  Caducidad crítica
                </h4>
                <h6 class="f-s-21 f-w-600 text-warning m-t-8">
                  {{caducidades.warning.toString()}}
                </h6>
              </mat-card-content>
            </mat-card>
          </div>
          <div class="topcard-item col-sm-6 col-lg-4">
            <mat-card class="text-center">
              <mat-card-content>
                <img
                  src="/assets/images/lotesCaducado.png"
                  alt="users"
                  width="70" />
                <h4 class="f-s-14 f-w-600 text-error m-t-8">
                  Lotes Caducados
                </h4>
                <h6 class="f-s-21 f-w-600 text-error m-t-8">
                  {{caducidades.peligro.toString()}}
                </h6>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
        <mat-card class="cardWithShadow"
          style="margin-bottom: 16px !important;">
          <mat-card-content
            style="padding-top: 16px !important; padding-bottom: 16px !important;">
            <div class="row justify-content-between">
              <div class="col-lg-3">
                <mat-form-field appearance="outline" class="w-100 hide-hint">
                  <mat-label>{{ 'buscar' | translate }}</mat-label>
                  <input matInput
                    [placeholder]="'buscar_placeholder' | translate"
                    (keyup)="applyFilter($any($event.target).value)" />
                  <mat-icon matSuffix>
                    <i-tabler name="search"
                      class="icon-20 d-flex m-t-2"></i-tabler>
                  </mat-icon>
                </mat-form-field>
              </div>
              <div class="col-lg-3">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>{{ 'producto' | translate }}</mat-label>
                  <mat-select [(ngModel)]="productoSeleccionado"
                    [placeholder]="'selecciona_producto' | translate"
                    (selectionChange)="onProductoChange()">
                    <mat-option *ngFor="let producto of productoOptions"
                      [value]="producto.value">
                      {{ (producto.label || '') | translate }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="col-lg-3">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>{{ 'variante' | translate }}</mat-label>
                  <mat-select [(ngModel)]="varianteSeleccionada"
                    [placeholder]="'selecciona_variante' | translate"
                    (selectionChange)="onFilter()">
                    <mat-option *ngFor="let variante of varianteOptions"
                      [value]="variante.value">
                      {{ (variante.label || '') | translate }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="col-lg-3">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>{{ 'almacen' | translate }}</mat-label>
                  <mat-select [(ngModel)]="selectedLocation"
                    [placeholder]="'selecciona_almacen' | translate"
                    (selectionChange)="onFilter()">
                    <mat-option *ngFor="let location of locationOptions"
                      [value]="location.value">
                      {{ (location.label || '') | translate }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="col-lg-3">
                <mat-checkbox [(ngModel)]="showDeleted" (change)="onFilter()"
                  color="primary">
                  {{ 'mostrar_lotes_inactivos' | translate }}
                </mat-checkbox>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </ng-container>

      <div class="row">
        <div class="main-panel" [ngClass]="{
            'col-12': compact && showOnlySearch,
            'col-12 col-lg-12': !(compact && showOnlySearch)
          }">
          <div class="b-1 rounded">
            <!-- Header SOLO buscador en modo compacto -->
            <ng-container
              *ngIf="compact && showOnlySearch; else normalHeader">
              <div
                class="justify-content-between gap-16 d-flex align-items-center b-b-1"
                style="height: 71px;">
                <div
                  class="col-sm-7 d-flex align-items-center justify-content-between"
                  style="margin-left: 29px !important;">
                  <mat-form-field appearance="outline" class="hide-hint"
                    style="min-width:320px; flex:1; max-width:500px;">
                    <mat-label>Buscar</mat-label>
                    <input matInput placeholder="Lote, producto o variante..."
                      (keyup)="applyFilter($any($event.target).value)" />
                    <mat-icon matSuffix>
                      <i-tabler name="search"
                        class="icon-20 d-flex m-t-2"></i-tabler>
                    </mat-icon>
                  </mat-form-field>
                  <button mat-flat-button color="primary"
                    [routerLink]="['/lotes']"
                    style="left: 290px; width: 120px;">
                    Ir a Lotes
                  </button>
                </div>
              </div>
            </ng-container>
            <ng-template #normalHeader>
              <div
                class="justify-content-between gap-16 d-flex align-items-center b-b-1"
                style="height: 71px;">
                <div class="col-sm-4" style="margin-left: 29px !important;">
                  <h5>{{ 'lotes_y_caducidades' | translate }}</h5>
                </div>
                <div
                  class="col-sm-6 d-flex align-items-center justify-content-end ">
                  <!-- Mostrar botón diferente según modo -->
                  <button *ngIf="!compact" mat-flat-button
                    (click)="openDialog('Add', {}, productoOptions, varianteOptions, locationOptions)"
                    color="primary" style="margin-right: 15px !important;">
                    + {{ 'entrada_lote' | translate }}
                  </button>
                  <button *ngIf="compact" mat-flat-button color="primary"
                    [routerLink]="['/lotes']"
                    style="margin-right: 15px !important;">
                    Ir a Lotes
                  </button>
                </div>
              </div>
            </ng-template>
            <table mat-table [dataSource]="dataSource" matSort
              (matSortChange)="onSort($event)"
              class="w-100"
              [ngClass]="{'compact-table': compact}">

              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef class="p-l-0 ">
                  <mat-checkbox (change)="$event ? masterToggle() : null"
                    [checked]="selection.hasValue() && isAllSelected()"
                    color="primary"
                    [indeterminate]="selection.hasValue() && !isAllSelected()"
                    [aria-label]="checkboxLabel()"
                    class="m-l-16">
                  </mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let row" class="p-l-0">
                  <mat-checkbox (click)="$event.stopPropagation()"
                    (change)="$event ? selection.toggle(row) : null"
                    color="primary" [checked]="selection.isSelected(row)"
                    [aria-label]="checkboxLabel(row)"
                    class="m-l-16">
                  </mat-checkbox>
                </td>
              </ng-container>
              <!-- LOTE -->
              <ng-container matColumnDef="lote_number">
                <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
                  {{ 'lote' | translate }}
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.lote_number }}
                </td>
              </ng-container>

              <!-- PRODUCTO + VARIANTE -->
              <ng-container matColumnDef="producto">
                <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
                  {{ 'producto' | translate }}
                </th>
                <td mat-cell *matCellDef="let element">
                  <div class="d-flex align-items-center gap-16">
                    <img class="rounded-circle" [src]="element.product_image"
                      width="45" />
                    <div>
                      <h6 class="f-w-600 f-s-16 m-t-0">
                        {{ element.product_name }}
                      </h6>
                      <span class="f-s-14">
                        {{ element.variant_name || '-' }}
                      </span>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- ALMACÉN -->
              <ng-container matColumnDef="almacen">
                <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
                  {{ 'almacen' | translate }}
                </th>
                <td mat-cell *matCellDef="let element" class="f-s-14">
                  {{ element.warehouse_name }}
                </td>
              </ng-container>

              <!-- RESTANTE -->
              <ng-container matColumnDef="restante">
                <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
                  {{ 'restante' | translate }}
                </th>
                <td mat-cell *matCellDef="let element" class="f-s-14">
                  {{ element.remaining }}
                </td>
              </ng-container>

              <!-- CADUCIDAD -->
              <ng-container matColumnDef="caducidad">
                <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="f-s-16 f-w-600">
                  {{ 'caducidad' | translate }}
                </th>
                <td mat-cell *matCellDef="let element" class="f-s-14">
                  <span
                    class="bg-light f-w-500 p-x-8 p-y-4 rounded-pill f-s-12"
                    [ngClass]="{
                        'bg-light-warning': element.expiration_date && isWarning(element.expiration_date),
                        'bg-light-error': element.expiration_date && isDanger(element.expiration_date),
                        'bg-light-primary': !element.expiration_date || isCorrect(element.expiration_date)
                      }">
                    {{ element.expiration_date ? (element.expiration_date |
                    date:'shortDate') : '-' }}
                  </span>
                </td>
              </ng-container>

              <!-- FECHA LLEGADA -->
              <ng-container matColumnDef="Llegada">
                <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="f-s-16 f-w-600">
                  {{ 'llegada' | translate }}
                </th>
                <td mat-cell *matCellDef="let element" class="f-s-14">
                  {{ element.fecha_llegada ? (element.fecha_llegada |
                  date:'shortDate') : '-' }}
                </td>
              </ng-container>

              <!-- ACCIONES -->
              <ng-container matColumnDef="action">
                <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
                  {{ 'accion' | translate }}
                </th>
                <td mat-cell *matCellDef="let element" class="action-link">
                  <button mat-stroked-button color="warning"
                    style="margin-right:.5em;"
                    (click)="openDialog('Update', element, productoOptions, varianteOptions, locationOptions)">
                    {{ 'editar' | translate }}
                  </button>

                  <button mat-stroked-button color="error"
                    (click)="openDialog('Delete', element, productoOptions, varianteOptions, locationOptions)">
                    {{ 'eliminar' | translate }}
                  </button>
                </td>
              </ng-container>

              <!-- Filas -->
              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row
                *matRowDef="let row; columns: displayedColumns"></tr>
            </table>

            <mat-paginator class="b-t-1"
              style="border-radius: 0px 0px 10px 10px !important"
              [pageSizeOptions]="[5,10,20]"
              [pageSize]="lotesPorPagina"
              [length]="totalLotes"
              showFirstLastButtons>
            </mat-paginator>
          </div>
        </div>

      </div>
    </div>
  </div>
</ion-content>