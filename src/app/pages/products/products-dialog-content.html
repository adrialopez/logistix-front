<div
  class="d-flex align-items-center justify-content-between m-b-8 p-x-20 p-t-16">
  <h3>{{action}} producto</h3>
  <button mat-icon-button mat-dialog-close
    class="d-flex justify-content-center">
    <i-tabler name="x" class="icon-20 d-flex"></i-tabler>
  </button>
</div>

@if(action !== 'Delete') {
<mat-dialog-content>
  <form #userForm="ngForm" class="container-fluid">
    <div class="row">
      <!-- SKU producto -->
      <div class="col-lg-1 d-flex justify-content-end px-0">
        <img
          *ngIf="local_data.image"
          [src]="local_data.image"
          alt="imagen"
          width="45"
          height="45"
          style="border-radius:4px; height:45px; object-fit:cover;" />
        <div *ngIf="!local_data.image"
          class="d-flex justify-content-center text-muted"
          style="width:45px; height:45px; border-radius:4px; background:#f2f2f2;">
          —
        </div>
      </div>

      <div class="col-lg-5">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Nombre</mat-label>
          <input
            type="text"
            matInput
            required
            id="name"
            name="name"
            [(ngModel)]="local_data.name"
            placeholder="Nombre"
            [disabled]="isView" />
        </mat-form-field>
      </div>
      <!-- URL de la imagen (se guarda en BD) -->
      <div class="col-lg-6">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>URL imagen</mat-label>
          <input
            type="url"
            matInput
            id="image"
            name="image"
            [(ngModel)]="local_data.image"
            placeholder="https://…"
            [disabled]="isView" />
        </mat-form-field>
      </div>

      <!-- Nombre producto -->

      <!-- Variantes -->
      <div *ngIf="action === 'Update' || action === 'View' || action === 'Add'" class="col-12 w-100">
        <div
          class="d-flex align-items-center justify-content-between m-b-8 m-l-15">
          <mat-label class="f-s-14 f-w-600 d-block">Variantes</mat-label>
          <div class="d-flex" style="gap:.5rem;">
            <button mat-stroked-button color="primary" type="button"
              (click)="addVariante()"
              *ngIf="!isView">
              Añadir variante
            </button>
          </div>
        </div>

        <mat-card class="cardWithShadow b-1 rounded p-30">
          <div
            class="row mb-2"
            style="align-items:flex-start;"
            *ngFor="let v of variantes; let i = index">

            <!-- NAME -->
            <div class="col-lg-2">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Variante</mat-label>
                <input
                  required
                  matInput
                  type="text"
                  [(ngModel)]="v.name"
                  name="var_name_{{i}}"
                  placeholder="Nombre de la variante"
                  (ngModelChange)="markDirty(v)"
                  [disabled]="isView" />
              </mat-form-field>
            </div>

            <!-- SKU (solo editable si es fila nueva; en View, deshabilitado) -->
            <div class="col-lg-2">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>SKU</mat-label>
                <input
                  matInput
                  required
                  [disabled]="isView"
                  [class.text-muted]="!v.__isNew || isView"
                  [(ngModel)]="v.sku"
                  name="var_sku_{{i}}"
                  placeholder="SKU"
                  (ngModelChange)="onSkuInput(v, $event)" />
                <mat-error *ngIf="!isView && v.__skuError">{{ v.__skuError
                  }}</mat-error>
              </mat-form-field>
            </div>

            <div class="col-lg-2">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>EAN</mat-label>
                <input
                  matInput
                  type="text"
                  [(ngModel)]="v.ean"
                  name="var_ean_{{i}}"
                  placeholder="EAN"
                  (ngModelChange)="onEanInput(v, $event)"
                  [disabled]="isView" />
                <mat-error *ngIf="!isView && v.__eanError">{{ v.__eanError
                  }}</mat-error>
              </mat-form-field>
            </div>

            <!-- Peso -->
            <div class="col-lg-2">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Peso (kg)</mat-label>
                <input
                  matInput
                  type="number"
                  step="0.001"
                  min="0"
                  [(ngModel)]="v.weight"
                  name="var_weight_{{i}}"
                  placeholder="Peso"
                  (ngModelChange)="markDirty(v)"
                  [disabled]="isView" />
              </mat-form-field>
            </div>

            <!-- Precio -->
            <div class="col-lg-2">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Precio (€)</mat-label>
                <input
                  matInput
                  type="number"
                  step="0.01"
                  min="0"
                  [(ngModel)]="v.price"
                  name="var_price_{{i}}"
                  placeholder="Precio"
                  (ngModelChange)="markDirty(v)"
                  [disabled]="isView" />
              </mat-form-field>
            </div>

            <div class="col-lg-1 d-flex align-items-center"
              style="height: 37px;">
              <mat-label>
                <b>{{v.stock_total}} uds.</b>
              </mat-label>
            </div>

            <!-- Acciones -->
            <div class="col-lg-1 d-flex align-items-center">

              <button mat-stroked-button color="error" type="button"
                (click)="rmVariante(v.id)"
                *ngIf="!isView">
                Eliminar
              </button>

            </div>
          </div>
        </mat-card>
      </div>
    </div>

    <!-- Botones finales -->
    <button
      style="float:right;"
      matTooltip="Guarda el producto y todas las variantes nuevas/modificadas."
      mat-flat-button
      (click)="doAction()"
      class="m-l-8"
      [disabled]="!userForm.valid || hasIdErrors()"
      *ngIf="!isView">
      {{action}}
    </button>
    <button style="float:right;" mat-flat-button class="bg-error text-white"
      (click)="closeDialog()">
      Cerrar
    </button>
  </form>
</mat-dialog-content>
}

@else {
<div class="p-x-24 m-y-8">
  <p class="f-s-14">
    Sure to delete <span class="f-w-600">{{local_data.name}}</span> ?
  </p>
</div>
<div mat-dialog-actions class="p-x-24 p-b-24">
  <button mat-flat-button (click)="closeDialog()"
    class="m-l-8 bg-error text-white">
    Cancel
  </button>
  <button (click)="delete()" mat-flat-button>{{action}}</button>
</div>
}
