<ion-content [fullscreen]="true">
  <div class="contenedor">
    <div class="contenido" [ngClass]="{'sin-padding': compact}">
      <!-- topcards solo en vista completa -->
      <div class="row" *ngIf="!compact"
        style="display:flex; justify-content: center;">

        <div class="topcard-item col-sm-6 col-lg-2">
          <mat-card class="text-center"
            [ngClass]="{'card-active': selectedCategory === ''}"
            (click)="btnCategoryClick('')">
            <mat-card-content class="card-pointer">
              <img src="/assets/images/pendingOrders.png" alt="users"
                width="70" />
              <h4 class="f-s-14 f-w-600 text-primary m-t-8">
                {{ 'total_pedidos' | translate }}
              </h4>
              <h6 class="f-s-21 f-w-600 text-primary m-t-8">
                {{ stats?.total || 0 }}
              </h6>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="topcard-item col-sm-6 col-lg-2">
          <mat-card class="text-center"
            [ngClass]="{'card-active': selectedCategory === 'SIN_PREPARAR'}"
            (click)="btnCategoryClick('SIN_PREPARAR')">
            <mat-card-content class="card-pointer">
              <img src="/assets/images/newOrders.png" alt="users" width="70" />
              <h4 class="f-s-14 f-w-600 text-primary m-t-8">
                {{ 'sin_preparar' | translate }}
              </h4>
              <h6 class="f-s-21 f-w-600 text-primary m-t-8">
                {{ stats?.SIN_PREPARAR || 0 }}
              </h6>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="topcard-item col-sm-6 col-lg-2">
          <mat-card class="text-center" (click)="btnCategoryClick('PREPARADO')"
            [ngClass]="{'card-active': selectedCategory === 'PREPARADO'}">
            <mat-card-content class="card-pointer">
              <img src="/assets/images/shippedOrder.png" alt="users"
                width="70" />
              <h4 class="f-s-14 f-w-600 text-primary m-t-8">
                {{ 'preparado' | translate }}
              </h4>
              <h6 class="f-s-21 f-w-600 text-primary m-t-8">
                {{ stats?.PREPARADO || 0 }}
              </h6>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="topcard-item col-sm-6 col-lg-2">
          <mat-card class="text-center" (click)="btnCategoryClick('FINALIZADO')"
            [ngClass]="{'card-active': selectedCategory === 'FINALIZADO'}">
            <mat-card-content class="card-pointer">
              <img src="/assets/images/orderPrepared.png" alt="users"
                width="70" />
              <h4 class="f-s-14 f-w-600 text-primary m-t-8">
                {{ 'finalizado' | translate }}
              </h4>
              <h6 class="f-s-21 f-w-600 text-primary m-t-8">
                {{ stats?.FINALIZADO || 0 }}
              </h6>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="topcard-item col-sm-6 col-lg-2">
          <mat-card class="text-center" (click)="btnCategoryClick('CANCELADO')"
            [ngClass]="{'card-active': selectedCategory === 'CANCELADO'}">
            <mat-card-content class="card-pointer">
              <img src="/assets/images/ordersCancelled.png" alt="users"
                width="70" />
              <h4 class="f-s-14 f-w-600 text-error m-t-8">
                {{ 'cancelado' | translate }}
              </h4>
              <h6 class="f-s-21 f-w-600 text-error m-t-8">
                {{ stats?.CANCELADO || 0 }}
              </h6>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
      <mat-card class="cardWithShadow" *ngIf="!compact">
        <mat-card-content>
          <div class="row justify-content-between gap-16">
            <div class="col-sm-4">
              <mat-form-field appearance="outline" class="hide-hint">
                <input matInput (keyup)="onKeyup($event)"
                  [placeholder]="'buscar_pedido' | translate" />
                <mat-icon matSuffix>
                  <i-tabler name="search"
                    class="icon-20 d-flex m-t-2"></i-tabler>
                </mat-icon>
              </mat-form-field>
            </div>
            <div class="d-flex align-items-center justify-content-end m-b-8">
              <mat-chip-set>
                <mat-chip color="primary" selected>
                  <mat-icon inline>schedule</mat-icon>
                  <span style="margin-left:6px;">{{ countdownText }}</span>
                </mat-chip>
              </mat-chip-set>
              <button
                mat-icon-button
                class="m-l-8"
                [disabled]="isRefreshing"
                (click)="refreshAll()"
                matTooltip="Recargar catálogos y pedidos">
                <mat-icon [class.spin]="isRefreshing">refresh</mat-icon>
              </button>
            </div>
            <div class="col-sm-4 d-flex justify-content-end align-items-center">
              <button mat-flat-button color="primary"
                class="d-flex justify-content-center align-items-center"
                (click)="openDialog('Add', productoOptions, shop, null, varianteOptions, smethodsOptions, carriersOptions)">
                {{ 'crear_pedido' | translate }}
              </button>

              <!-- En modo compact: ir a la página completa de Pedidos -->
              <button *ngIf="compact" mat-flat-button color="primary"
                class="d-flex justify-content-center align-items-center"
                [routerLink]="['/pedidos']">
                {{ 'ir_a_pedidos' | translate }}
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="tabla-wrapper">
        <div class="row">
          <div class="main-panel col-12">
            <div class="b-1 rounded">
              <ng-container *ngIf="compact">
                <div
                  class="justify-content-between gap-16 d-flex align-items-center b-b-1"
                  style="height: 71px;">
                  <div class="d-flex align-items-center justify-content-between"
                    style="margin-left: 29px !important;">
                    <mat-form-field appearance="outline" class="hide-hint"
                      style="min-width:320px; flex:1; max-width:500px;">
                      <input matInput (keyup)="onKeyup($event)"
                        [placeholder]="'buscar_pedido' | translate" />
                      <mat-icon matSuffix>
                        <i-tabler name="search"
                          class="icon-20 d-flex m-t-2"></i-tabler>
                      </mat-icon>
                    </mat-form-field>

                    <button mat-flat-button color="primary"
                      class="d-flex justify-content-center align-items-center"
                      [routerLink]="['/pedidos']"
                      style="left: 280px; width: 120px;">
                      {{ 'ir_a_pedidos' | translate }}
                    </button>
                  </div>
                </div>
              </ng-container>
              <table #table mat-table matSort [dataSource]="dataSource"
                class="w-100"
                [ngClass]="{'compact-table': compact}">

                <ng-container matColumnDef="index">
                  <th mat-header-cell *matHeaderCellDef style="width:50px;">{{
                    'integracion' | translate }}</th>
                  <td mat-cell *matCellDef="let pedido"
                    style="text-align: center;">
                    <img
                      [src]="pedido.platform === 'shopify'
                        ? 'assets/images/svgs/shopify.svg'
                        : pedido.platform === 'woocommerce' ? 'assets/images/svgs/woocommerce.svg' : 'assets/images/api.png'"
                      [alt]="pedido.platform === 'shopify' ? 'Shopify' : pedido.platform === 'woocommerce' ? 'WooCommerce' : 'API'"
                      width="22" />
                  </td>
                </ng-container>

                <ng-container matColumnDef="pais">
                  <th mat-header-cell *matHeaderCellDef
                    mat-sort-header="pais">{{ 'pais' | translate }}</th>
                  <td mat-cell *matCellDef="let pedido">
                    <span
                      [class]="'flag-icon flag-icon-' + pedido?.country?.toLowerCase()"
                      style="margin-right: 8px;"></span>
                    {{ pedido.country }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="order_number">
                  <th mat-header-cell *matHeaderCellDef
                    mat-sort-header="order_number">{{ 'pedido' | translate
                    }}</th>
                  <td mat-cell *matCellDef="let pedido">
                    <div
                      style="display: flex; align-items: center; justify-content: space-between;">
                      <span>{{ pedido.order_number }}</span>
                      <mat-icon *ngIf="pedido?.notas_internas"
                        matTooltip="Tiene notas internas"
                        matTooltipPosition="above" class="icon-16"
                        aria-label="Notas internas">
                        info
                      </mat-icon>
                    </div>

                  </td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef
                    mat-sort-header="status">{{ 'estado' | translate }}</th>
                  <td mat-cell *matCellDef="let pedido">
                    <span
                      class="bg-light f-w-500 p-x-8 p-y-4 rounded-pill f-s-12"
                      [ngClass]="pedido._badgeClass">
                      {{ pedido._canonicalLabel | translate }}
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="cliente">
                  <th mat-header-cell *matHeaderCellDef
                    mat-sort-header="cliente">{{ 'cliente' | translate }}</th>
                  <td mat-cell *matCellDef="let pedido">
                    {{ pedido.customer_name }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="tracking">
                  <th mat-header-cell *matHeaderCellDef>{{ 'tracking' |
                    translate }}</th>
                  <td mat-cell *matCellDef="let pedido">
                    <ng-container
                      *ngIf="pedido?.tracking_number && pedido.tracking_number !== ''; else noTracking">
                      <ng-container
                        *ngIf="pedido?.tracking_url && pedido.tracking_url !== ''; else trackingPlain">
                        <a [href]="pedido.tracking_url" target="_blank"
                          rel="noopener">
                          {{ pedido.tracking_number }}
                        </a>
                      </ng-container>
                      <ng-template #trackingPlain>
                        <span>{{ pedido.tracking_number }}</span>
                      </ng-template>
                    </ng-container>
                    <ng-template #noTracking>-</ng-template>
                  </td>
                </ng-container>

                <ng-container matColumnDef="fecha">
                  <th mat-header-cell *matHeaderCellDef
                    mat-sort-header="fecha">{{ 'fecha_pedido' | translate
                    }}</th>
                  <td mat-cell *matCellDef="let pedido">
                    {{ pedido.created_at | date:'HH:mm:ss - dd/MM/yy' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="importe">
                  <th mat-header-cell *matHeaderCellDef
                    mat-sort-header="importe">{{ 'importe_unidades' |
                    translate
                    }}</th>
                  <td mat-cell *matCellDef="let pedido">
                    {{ pedido.total_amount }}€ / {{ pedido.total_units }} uds.
                  </td>
                </ng-container>

                <ng-container matColumnDef="action">
                  <th mat-header-cell *matHeaderCellDef></th>
                  <td mat-cell *matCellDef="let pedido"
                    style="text-align: right;" class="mat-column-action">

                    <button *ngIf="isEditable(pedido._canonicalStatus)"
                      mat-stroked-button color="warning"
                      (click)="openEditar(pedido)">
                      {{ 'editar' | translate }}
                    </button>

                    <button mat-stroked-button color="primary"
                      style="margin-left:.5em;" (click)="verDetalles(pedido)">
                      {{ 'detalles' | translate }}
                    </button>
                    <button *ngIf="isEditable(pedido._canonicalStatus)"
                      mat-stroked-button color="error"
                      style="margin-left:.5em;"
                      (click)="cancelPedido(pedido)">
                      {{ 'cancelar' | translate }}
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row
                  *matRowDef="let row; columns: displayedColumns;"></tr>
              </table>

              <mat-paginator [length]="totalCount" [pageSizeOptions]="[5,10,20]"
                [pageSize]="pedidosPorPagina"
                showFirstLastButtons>
              </mat-paginator>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</ion-content>